<!DOCTYPE html>
<html>
<head>
  <title>Pedidos</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #eaf0fa 0%, #ffffff 100%); font-family: 'Montserrat', Arial, sans-serif; margin: 0; padding: 0; color: #222; }
    .logo-container { text-align: center; margin-top: 30px; margin-bottom: 10px; }
      .logo-container img {
        width: 90px;
        height: 90px;
        object-fit: cover;
        border-radius: 18px;
        box-shadow: 0 4px 18px #0050d855;
        border: 3px solid #fff;
        background: #eaf0fa;
        transition: transform 0.3s, box-shadow 0.3s;
        animation: logoPop 1.2s cubic-bezier(.68,-0.55,.27,1.55) 1;
      }
      .logo-container img:hover {
        transform: scale(1.08) rotate(-2deg);
        box-shadow: 0 8px 32px #0050d8aa;
      }
    @keyframes logoPop { 0% { transform: scale(0.7); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
    .main-card {
          .main-card {
            animation: fadeInCard 1.1s cubic-bezier(.68,-0.55,.27,1.55) 1;
          }

          @keyframes fadeInCard {
            0% { opacity: 0; transform: translateY(40px) scale(0.98); }
            60% { opacity: 1; transform: translateY(-8px) scale(1.03); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
          }
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 8px 32px #0050d822;
      max-width: 1200px;
      width: 98vw;
      margin: 32px auto 0 auto;
      padding: 38px 40px 28px 40px;
      transition: box-shadow 0.3s;
    }
    h2 { text-align: center; color: #0050d8; font-size: 2.2em; font-weight: 700; margin-bottom: 22px; letter-spacing: 1px; text-shadow: 0 2px 8px #0050d822; }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      align-items: center;
      margin-bottom: 22px;
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #f7faff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #0050d822;
      padding: 18px 24px 12px 24px;
    }
    label { font-weight: 600; color: #0050d8; margin-right: 6px; font-size: 1.1em; }
    input[type="text"], input[type="number"] { border: 2px solid #b3c6e6; border-radius: 10px; padding: 9px 14px; font-size: 1.08em; outline: none; transition: border 0.2s; background: #f7faff; }
    input[type="text"]:focus, input[type="number"]:focus { border-color: #0050d8; background: #eaf0fa; }
    button { background: linear-gradient(90deg, #0050d8 60%, #0077ff 100%); color: #fff; border: none; border-radius: 10px; padding: 10px 28px; font-size: 1.08em; font-weight: 700; cursor: pointer; box-shadow: 0 2px 12px #0050d822; transition: background 0.2s, box-shadow 0.2s, transform 0.2s; margin-top: 4px; }
    button:hover { background: linear-gradient(90deg, #0077ff 60%, #0050d8 100%); box-shadow: 0 6px 24px #0050d822; transform: scale(1.07); }
    #mensajeError { width: 100%; text-align: center; color: #d80032; font-weight: 600; margin-top: 8px; margin-bottom: 0; font-size: 1.08em; }
    .table-container {
      margin-top: 22px;
      overflow-x: auto;
      max-width: 100vw;
      width: 100%;
      min-width: 800px;
      padding: 0 12px;
    }
    table {
      width: 100%;
      min-width: 800px;
      border-collapse: separate;
      border-spacing: 0;
      background: #f7faff;
      border-radius: 14px;
      box-shadow: 0 2px 16px #0050d822;
      overflow: hidden;
    }
    th { background: linear-gradient(90deg, #0050d8 60%, #0077ff 100%); color: #fff; font-weight: 700; padding: 14px 10px; font-size: 1.08em; border-right: 1px solid #eaf0fa; }
    th:last-child { min-width: 120px; }
    td { padding: 12px 10px; font-size: 1.08em; text-align: center; border-bottom: 1px solid #eaf0fa; background: #fff; transition: background 0.2s; }
    td:last-child { min-width: 120px; }
    tr:nth-child(even) td { background: #f0f4fc; }
    tr:hover td { background: #eaf0fa; }
    tr:last-child td { border-bottom: none; }
    td img { border-radius: 10px; box-shadow: 0 2px 8px #0050d822; background: #eaf0fa; border: 1px solid #b3c6e6; transition: transform 0.2s; }
    td img:hover { transform: scale(1.2); box-shadow: 0 4px 16px #0050d822; }
    .totalizador { margin-top: 22px; text-align: right; font-size: 1.22em; font-weight: 700; color: #0050d8; }
    .totalizador .iva { color: #0077ff; font-size: 1.08em; font-weight: 600; }
    .totalizador .final { color: #0077ff; font-size: 1.32em; font-weight: 700; }
    @media (max-width: 800px) { .main-card { padding: 18px 6px 12px 6px; max-width: 98vw; } table th, table td { font-size: 0.98em; padding: 8px 4px; } form { gap: 10px; } }
  </style>
</head>
<body>
  <div class="main-card">
      <div class="logo-container">
        <img src="https://res.cloudinary.com/dipt3jq6r/image/upload/v1764307686/NIOVAL-05_xhfrrh.jpg" alt="Logo Nioval">
      </div>
      <h2>Crear nuevo pedido</h2>
      <form id="pedidoForm" method="POST" action="/pedidos" style="box-shadow: 0 2px 12px #0050d822; border-radius: 16px; background: #f7faff; padding: 22px 28px 16px 28px; margin-bottom: 22px; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto;">
        <label for="sku">SKU:</label>
        <input type="text" id="sku" name="sku" style="margin-bottom: 10px;">
        <label for="cantidad">Cantidad:</label>
        <input type="number" id="cantidad" name="cantidad" min="1" required style="margin-bottom: 10px;">
        <button type="button" onclick="agregarProducto()">Agregar</button>
        <div id="mensajeError"></div>
      </form>
      <div class="table-container">
        <div id="productosAgregados"></div>
        <form id="enviarPedidoForm" method="POST" action="/pedidos" style="margin-top: 18px; text-align: right;">
          <button type="submit" style="background: linear-gradient(90deg, #0050d8 60%, #0077ff 100%); color: #fff; border: none; border-radius: 10px; padding: 12px 32px; font-size: 1.12em; font-weight: 700; cursor: pointer; box-shadow: 0 2px 12px #0050d822;">Enviar pedido</button>
        </form>
      </div>
    </div>
  <!-- Modal de confirmación visual -->
  <div id="modalConfirm" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,32,128,0.18); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#fff; border-radius:18px; box-shadow:0 8px 32px #0050d822; padding:38px 32px 28px 32px; max-width:340px; text-align:center;">
      <h3 style="color:#0050d8; font-size:1.3em; margin-bottom:18px;">¿Confirmar envío de pedido?</h3>
      <p style="color:#222; margin-bottom:22px;">¿Estás seguro de que deseas enviar el pedido?</p>
      <button id="btnConfirmar" style="background:linear-gradient(90deg,#0050d8 60%,#0077ff 100%); color:#fff; border:none; border-radius:10px; padding:10px 28px; font-size:1.08em; font-weight:700; cursor:pointer; margin-right:10px;">Confirmar</button>
      <button id="btnCancelar" style="background:#eaf0fa; color:#0050d8; border:none; border-radius:10px; padding:10px 28px; font-size:1.08em; font-weight:700; cursor:pointer;">Cancelar</button>
    </div>
  </div>
  <!-- Bloque JS movido al final -->
  <script>
  var productos = {{ productos|tojson|safe }};
  var precio_esquema = "{{ precio_esquema }}";
  let productosPedido = [];
  // var skus = productos.map(p => p['SKU']);
  // document.getElementById('skusDisponibles').innerHTML = 'SKUs disponibles: ' + skus.join(', ');

  function agregarProducto() {
    const sku = document.getElementById('sku').value.trim();
    const cantidad = parseInt(document.getElementById('cantidad').value);
    const mensajeDiv = document.getElementById('mensajeError');
    mensajeDiv.innerText = '';
    if (!cantidad || cantidad < 1) {
      mensajeDiv.innerText = 'Debes ingresar una cantidad válida.';
      return;
    }
    // Si el SKU está vacío, se permite agregar el producto sin buscarlo en la base
    let producto = null;
    if (sku) {
      const skuInput = sku.toString().trim().toLowerCase();
      producto = productos.find(function(p) {
        let skuDb = (p['SKU'] || p['sku'] || '').toString().trim().toLowerCase();
        return skuDb === skuInput;
      });
      if (!producto) {
        mensajeDiv.innerText = 'SKU no encontrado. Verifica que esté correcto.';
        return;
      }
    }
    productosPedido.push({ sku: sku, cantidad: cantidad, producto: producto });
    mostrarProductosAgregados();
    document.getElementById('sku').value = '';
    document.getElementById('cantidad').value = '';
    mensajeDiv.innerText = '';
  }

  function mostrarProductosAgregados() {
    const div = document.getElementById('productosAgregados');
    div.innerHTML = '<h3>Productos agregados:</h3>';
    if (productosPedido.length === 0) return;
    let html = '<table border="1"><tr><th>SKU</th><th>Foto</th><th>Nombre</th><th>Precio</th><th>Cantidad</th><th>Total</th><th>Acciones</th></tr>';
    let totalCotizacion = 0;
    productosPedido.forEach(function(item, idx) {
        let precio = item.producto ? (parseFloat(item.producto[precio_esquema]) || 0) : 0;
        let totalItem = precio * item.cantidad;
        totalCotizacion += totalItem;
        html += '<tr>' +
          '<td>' + item.sku + '</td>' +
          '<td>' + (item.producto && item.producto.Foto ? '<img src="' + item.producto.Foto + '" width="50" height="50" onerror="this.outerHTML=\'Sin foto\'">' : 'Sin foto') + '</td>' +
          '<td>' + (item.producto && item.producto.Nombre ? item.producto.Nombre : '') + '</td>' +
          '<td>' + precio.toFixed(2) + '</td>' +
          '<td><input type="number" min="1" value="' + item.cantidad + '" onchange="modificarCantidad(' + idx + ', this.value)"></td>' +
          '<td style="text-align:right; font-weight:bold;">' + totalItem.toFixed(2) + '</td>' +
          '<td style="min-width:120px;"><button type="button" style="width:100%; min-width:90px;" onclick="eliminarProducto(' + idx + ')">Eliminar</button></td>' +
        '</tr>';
    });
    html += '</table>';
    div.innerHTML += html;
    // Totalizador general debajo de la tabla
    if (productosPedido.length > 0) {
      div.innerHTML += '<div style="margin-top:10px; text-align:right; font-size:1.2em; font-weight:bold;">Cotización: $' + totalCotizacion.toFixed(2) + '</div>';
      let iva = totalCotizacion * 0.16;
      div.innerHTML += '<div style="margin-top:5px; text-align:right; font-size:1.1em; font-weight:bold;">IVA (16%): $' + iva.toFixed(2) + '</div>';
      let totalFinal = totalCotizacion + iva;
      div.innerHTML += '<div style="margin-top:5px; text-align:right; font-size:1.3em; font-weight:bold; color:#0050d8;">TOTAL: $' + totalFinal.toFixed(2) + '</div>';
    }
  }

  function eliminarProducto(idx) {
    productosPedido.splice(idx, 1);
    mostrarProductosAgregados();
  }

  function modificarCantidad(idx, nuevaCantidad) {
    nuevaCantidad = parseInt(nuevaCantidad);
    if (nuevaCantidad > 0) {
      productosPedido[idx].cantidad = nuevaCantidad;
    }
    mostrarProductosAgregados();
  }

  document.getElementById('enviarPedidoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('modalConfirm').style.display = 'flex';
  });

  document.getElementById('btnConfirmar').onclick = function() {
    document.getElementById('modalConfirm').style.display = 'none';
    document.getElementById('enviarPedidoForm').submit();
  };
  document.getElementById('btnCancelar').onclick = function() {
    document.getElementById('modalConfirm').style.display = 'none';
  };
  </script>
</body>
</html>